---
import Divider from '../ui/Divider.astro';
import { getImageBaseUrl } from '../../utils/images';

// Get dynamic image URLs
const bridgeImage = `${getImageBaseUrl()}/Bridge 3.png`;
const bridgeLightImage = `${getImageBaseUrl()}/Bridge light.png`;
interface FAQ {
  id: string;
  question: string;
  answer: string;
}

const faqs: FAQ[] = [
  {
    id: 'gmc-what',
    question: 'What is the Gelephu Mindfulness City (GMC)?',
    answer:
      'Gelephu Mindfulness City (GMC) is a Special Administrative Region (SAR) in the Kingdom of Bhutan, designed as a premier destination for mindful, sustainable, and transformative travel.',
  },
  {
    id: 'gmc-vision',
    question: 'What is the vision behind GMC?',
    answer:
      'GMC is designed as a place where spirituality, wellness, and eco-conscious living come together, offering unique opportunities for retreats, eco-tourism, and cultural exchange.',
  },
  {
    id: 'sar-context',
    question: 'What is a Special Administrative Region (SAR) in this context?',
    answer:
      'A Special Administrative Region (SAR) is a designated area with its own governance structure and legal framework, operating within the Kingdom of Bhutan while maintaining certain autonomous characteristics.',
  },
  {
    id: 'investment-approach',
    question: "What is GMC's approach to investments?",
    answer:
      "GMC offers a dynamic investment framework designed to attract sustainable and mindful businesses that align with the region's values of wellness, spirituality, and eco-consciousness.",
  },
  {
    id: 'legal-framework',
    question: 'What legal framework does GMC offer to investors?',
    answer:
      'GMC provides a comprehensive legal framework that includes long-term leases, business registration support, and investment concierge services to facilitate smooth entry for investors.',
  },
  {
    id: 'gmc-location',
    question: 'Where is GMC located?',
    answer:
      'GMC is located in Gelephu, Bhutan, with a new international airport under development and improved road and rail connections to welcome travelers from around the world.',
  },
];
---

<section
  id="faq-section"
  class="faq-section relative overflow-hidden px-4 py-16 md:px-8 lg:px-16"
  style={`--bridge-image: url('${bridgeImage}'); --bridge-light-image: url('${bridgeLightImage}');`}
>
  <div class="faq-background" aria-hidden="true"></div>

  <div class="relative z-10 mx-auto w-full max-w-4xl space-y-8">
    <!-- Centered Heading -->
    <h2 class="faq-heading text-4xl md:text-5xl font-bold text-center mb-4">
      Frequently Asked Questions
    </h2>
    <Divider className="mb-12" width="80%" />

    <!-- FAQ List -->
    <div class="faq-list space-y-0" data-faq-list>
      {
        faqs.map((faq, index) => (
          <article class="faq-item border-b border-gray-300" data-faq-item>
            <button
              type="button"
              class="faq-toggle flex w-full items-center py-6 text-left"
              data-faq-toggle
              data-target={`faq-panel-${faq.id}`}
              aria-expanded="false"
              aria-controls={`faq-panel-${faq.id}`}
            >
              <span class="faq-number text-base font-normal text-gray-400">/{index + 1}</span>
              <h3
                id={`faq-question-${faq.id}`}
                class="faq-question text-lg md:text-xl font-normal text-black flex-1"
              >
                {faq.question}
              </h3>
              <span class="faq-icon relative flex h-6 w-6 items-center justify-center">
                <i class="fa-solid fa-plus text-black text-lg" />
              </span>
            </button>
            <div
              id={`faq-panel-${faq.id}`}
              class="faq-panel text-base"
              data-faq-panel
              role="region"
              aria-labelledby={`faq-question-${faq.id}`}
              hidden
            >
              <p class="faq-body pb-6 pl-12 pr-2 text-gray-700">{faq.answer}</p>
            </div>
          </article>
        ))
      }
    </div>

    <!-- View All Link -->
    <div class="flex justify-center mt-8">
      <a
        href="https://gmc.bt/faq"
        class="faq-link group inline-flex items-center gap-2 text-base font-medium text-black transition"
      >
        View All
        <i class="fa-solid fa-arrow-right faq-link-icon"></i>
      </a>
    </div>
  </div>
</section>

<script is:inline>
  const script = document.currentScript;
  const componentRoot = script?.previousElementSibling;
  const section = componentRoot?.closest('.faq-section');

  if (section) {
    const toggles = Array.from(section.querySelectorAll('[data-faq-toggle]'));
    const filterSelect = section.querySelector('[data-faq-filter]');
    const articles = Array.from(section.querySelectorAll('[data-faq-item]'));
    let animating = false;
    let activeButton = null;

    const collapse = (button, panel) => {
      button.setAttribute('aria-expanded', 'false');
      button.parentElement?.classList.remove('is-active');
      panel.style.height = `${panel.scrollHeight}px`;
      panel.style.opacity = '1';
      requestAnimationFrame(() => {
        panel.style.height = '0px';
        panel.style.opacity = '0';
      });
      setTimeout(() => {
        panel.hidden = true;
        panel.classList.remove('is-open');
        animating = false;
      }, 320);
    };

    const expand = (button, panel) => {
      button.setAttribute('aria-expanded', 'true');
      button.parentElement?.classList.add('is-active');
      panel.hidden = false;
      panel.style.height = '0px';
      panel.style.opacity = '0';
      const targetHeight = panel.scrollHeight;
      requestAnimationFrame(() => {
        panel.style.height = `${targetHeight}px`;
        panel.style.opacity = '1';
      });
      setTimeout(() => {
        panel.style.height = 'auto';
        panel.classList.add('is-open');
        animating = false;
      }, 320);
    };

    const handleToggle = (button) => {
      if (animating) return;
      animating = true;
      const targetId = button.dataset.target;
      const panel = targetId ? section.querySelector(`#${targetId}`) : null;
      if (!panel) {
        animating = false;
        return;
      }

      const isOpen = button.getAttribute('aria-expanded') === 'true';

      if (isOpen) {
        collapse(button, panel);
        activeButton = null;
      } else {
        if (activeButton && activeButton !== button) {
          const activePanelId = activeButton.dataset.target;
          const activePanel = activePanelId ? section.querySelector(`#${activePanelId}`) : null;
          if (activePanel) {
            collapse(activeButton, activePanel);
          }
        }
        activeButton = button;
        expand(button, panel);
      }
    };

    toggles.forEach((button) => {
      button.addEventListener('click', () => {
        handleToggle(button);
      });
      button.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          handleToggle(button);
        }
      });
    });

    const applyFilter = (value) => {
      const normalized = value?.toLowerCase() ?? 'all';
      articles.forEach((article) => {
        const category = article.dataset.category ?? 'all';
        const visible = normalized === 'all' || category === normalized;
        article.classList.toggle('is-hidden', !visible);

        if (!visible) {
          const toggle = article.querySelector('[data-faq-toggle]');
          if (toggle && toggle === activeButton) {
            const targetId = toggle.dataset.target;
            const panel = targetId ? section.querySelector(`#${targetId}`) : null;
            if (panel) {
              collapse(toggle, panel);
            }
            activeButton = null;
          }
        }
      });
    };

    filterSelect?.addEventListener('change', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLSelectElement)) return;
      applyFilter(target.value);
    });

    if (filterSelect) {
      applyFilter(filterSelect.value);
    }
  }
</script>

<style>
  .faq-section {
    background: #f5f5f5;
    color: #000000;
  }

  .faq-background {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .faq-background::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60%;
    background-image: var(--bridge-image);
    background-repeat: no-repeat;
    background-position: bottom center;
    background-size: contain;
    opacity: 0.05;
    pointer-events: none;
  }

  :global([data-theme='dark']) .faq-background::after {
    background-image: var(--bridge-light-image);
  }

  .faq-heading {
    color: #000000;
    font-weight: 700;
  }

  .faq-toggle {
    gap: 2rem; /* Equal spacing between number, title, and icon */
  }

  .faq-question {
    color: #000000;
    font-weight: 400;
  }

  .faq-number {
    color: #9ca3af;
    font-weight: 400;
  }

  .faq-body {
    color: #374151;
  }

  .faq-icon i {
    transition: transform 0.3s ease;
  }

  .faq-item.is-active .faq-icon i {
    transform: rotate(45deg);
  }

  .faq-panel {
    overflow: hidden;
    height: 0;
    opacity: 0;
    transition:
      height 0.3s ease,
      opacity 0.3s ease;
  }

  .faq-panel.is-open {
    opacity: 1;
  }

  .faq-link {
    color: #000000;
  }

  .faq-link:hover {
    opacity: 0.7;
  }

  .faq-link i {
    transition: transform 0.2s ease;
  }

  .faq-link:hover i {
    transform: translateX(4px);
  }

  .faq-item.is-hidden {
    display: none;
  }

  /* Light theme styling */
  :global([data-theme='light']) .faq-section {
    background: #f5f5f5;
  }

  :global([data-theme='light']) .faq-heading,
  :global([data-theme='light']) .faq-question {
    color: #000000;
  }

  :global([data-theme='light']) .faq-number {
    color: #9ca3af;
  }

  :global([data-theme='light']) .faq-body {
    color: #000000;
  }

  :global([data-theme='light']) .faq-link {
    color: #000000;
  }

  :global([data-theme='light']) .faq-icon i {
    color: #000000;
  }

  /* Dark theme styling */
  :global([data-theme='dark']) .faq-section {
    background: #000000;
  }

  :global([data-theme='dark']) .faq-heading,
  :global([data-theme='dark']) .faq-question {
    color: #ffffff;
  }

  :global([data-theme='dark']) .faq-number {
    color: #9ca3af;
  }

  :global([data-theme='dark']) .faq-body {
    color: #d1d5db;
  }

  :global([data-theme='dark']) .faq-link {
    color: #ffffff;
  }

  .faq-link-icon {
    color: #000000;
  }

  :global([data-theme='dark']) .faq-link-icon {
    color: #ffffff !important;
  }

  :global([data-theme='dark']) .faq-icon i {
    color: #ffffff;
  }

  :global([data-theme='dark']) .faq-item {
    border-color: rgba(255, 255, 255, 0.1);
  }
</style>
