---
import EventCard from '../ui/EventCard.astro';
import { getCollection } from 'astro:content';
import Divider from '../ui/Divider.astro';
import { getLinkUrl } from '../../utils/images';

const allEvents = await getCollection('events');
const events = allEvents
  .sort((a, b) => b.data.startDate.getTime() - a.data.startDate.getTime())
  .slice(0, 3);
---

<!-- Latest Events Section -->
<section class="events-section py-16 px-4 sm:px-6 lg:px-8" data-animate-section="events">
  <div class="events-container max-w-7xl mx-auto">
    <h2
      class="events-section-title mb-4 text-center text-4xl md:text-5xl font-bold"
      data-animate-title
    >
      Upcoming Events
    </h2>
    <div data-animate-divider>
      <Divider className="mb-12" />
    </div>

    <!-- Events Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" data-animate-grid>
      {
        events.map((event) => (
          <div data-animate-item>
            <EventCard event={event} variant="simple" />
          </div>
        ))
      }
    </div>

    <!-- View All Link -->
    <div class="flex justify-center mt-12">
      <a
        href={getLinkUrl('/events')}
        class="view-all-link group inline-flex items-center gap-2 text-base font-medium transition"
      >
        View All
        <i class="fa-solid fa-arrow-right view-all-link-icon"></i>
      </a>
    </div>
  </div>
</section>

<style>
  .events-section {
    --events-bg: #090909;
    --events-heading: #f8fafc;
    --events-body: #cbd5f5;
    --events-border: rgba(255, 255, 255, 0.12);
    --events-icon: #ffffff;
    --events-button-bg: rgba(255, 255, 255, 0.05);
    background: var(--events-bg);
    color: var(--events-body);
  }

  :global([data-theme='light']) .events-section {
    --events-bg: #f5f5f5;
    --events-heading: #0f172a;
    --events-body: #475569;
    --events-border: rgba(15, 23, 42, 0.15);
    --events-icon: #0f172a;
    --events-button-bg: rgba(15, 23, 42, 0.05);
  }

  .events-section-title {
    color: var(--events-heading);
  }

  :global(.event-card) {
    --event-card-bg: var(--events-button-bg);
    --event-card-border: var(--events-border);
    --event-card-title: var(--events-heading);
    --event-card-meta: var(--events-body);
    --event-icon: var(--events-icon);
    --event-price: var(--events-heading);
  }

  /* GSAP animation initial states */
  [data-animate-title] {
    opacity: 0;
    transform: translateY(30px);
  }

  [data-animate-item] {
    opacity: 0;
    transform: translateY(50px);
  }

  [data-animate-divider] {
    opacity: 0;
    transform: translateY(20px);
  }

  .view-all-link {
    color: var(--events-heading);
  }

  .view-all-link:hover {
    opacity: 0.7;
  }

  .view-all-link i {
    transition: transform 0.2s ease;
  }

  .view-all-link:hover i {
    transform: translateX(4px);
  }

  .view-all-link-icon {
    color: var(--events-heading);
  }
</style>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  // Register ScrollTrigger plugin
  gsap.registerPlugin(ScrollTrigger);

  // Initialize animations when DOM is ready
  function initAnimations() {
    // Animate Upcoming Events Section
    const eventsSection = document.querySelector('[data-animate-section="events"]');
    if (eventsSection) {
      const eventsTitle = eventsSection.querySelector('[data-animate-title]');
      const eventsItems = eventsSection.querySelectorAll('[data-animate-item]');

      // Animate title
      if (eventsTitle) {
        gsap.to(eventsTitle, {
          opacity: 1,
          y: 0,
          duration: 0.8,
          ease: 'power3.out',
          scrollTrigger: {
            trigger: eventsSection,
            start: 'top 80%',
            toggleActions: 'play none none none',
          },
        });
      }

      // Animate divider
      const eventsDivider = eventsSection.querySelector('[data-animate-divider]');
      if (eventsDivider) {
        gsap.to(eventsDivider, {
          opacity: 1,
          y: 0,
          duration: 0.8,
          ease: 'power3.out',
          scrollTrigger: {
            trigger: eventsSection,
            start: 'top 80%',
            toggleActions: 'play none none none',
          },
        });
      }

      // Animate grid items with stagger
      if (eventsItems.length > 0) {
        gsap.to(eventsItems, {
          opacity: 1,
          y: 0,
          duration: 0.8,
          stagger: 0.2,
          ease: 'power3.out',
          scrollTrigger: {
            trigger: eventsSection.querySelector('[data-animate-grid]'),
            start: 'top 75%',
            toggleActions: 'play none none none',
          },
        });
      }
    }
  }

  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimations);
  } else {
    initAnimations();
  }
</script>
