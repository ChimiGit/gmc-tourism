---
import { getImageBaseUrl } from '../../utils/images';

interface DividerProps {
  className?: string;
  width?: string | number;
  height?: string | number;
}

const { className = '', width = '50%', height = '30px' } = Astro.props as DividerProps;

const widthValue = typeof width === 'number' ? `${width}px` : width;
const heightValue = typeof height === 'number' ? `${height}px` : height;

// Get dynamic image URLs
const dividerImage = `${getImageBaseUrl()}/divider.svg`;
const dividerLightImage = `${getImageBaseUrl()}/divider-light.svg`;
---

<div
  class={`relative my-4 flex w-full justify-center overflow-hidden ${className}`}
  data-divider-container
>
  <div
    style={{
      height: heightValue,
      width: widthValue,
      position: 'relative',
      overflow: 'hidden',
    }}
    data-divider-dark={dividerImage}
    data-divider-light={dividerLightImage}
  >
    <img
      src={dividerLightImage}
      alt=""
      class="h-full w-full object-contain"
      aria-hidden="true"
      data-divider-img
    />
  </div>
</div>

<script is:inline>
  (function () {
    function initDivider() {
      // Find all divider images on the page
      const dividerImages = document.querySelectorAll('[data-divider-img]');

      function updateDivider(img) {
        const theme = document.documentElement.getAttribute('data-theme') || 'dark';
        const container = img.closest('[data-divider-dark]');
        if (container) {
          const darkUrl = container.getAttribute('data-divider-dark');
          const lightUrl = container.getAttribute('data-divider-light');
          // Light mode: divider.svg, Dark mode: divider-light.svg
          img.src =
            theme === 'light' ? darkUrl || '/divider.svg' : lightUrl || '/divider-light.svg';
        } else {
          // Fallback to original behavior
          img.src = theme === 'light' ? '/divider.svg' : '/divider-light.svg';
        }
      }

      // Update all divider images
      dividerImages.forEach((img) => {
        updateDivider(img);
      });

      // Listen for theme change events from ThemeManager
      window.addEventListener('themechange', (e) => {
        dividerImages.forEach((img) => {
          const container = img.closest('[data-divider-dark]');
          if (container) {
            const darkUrl = container.getAttribute('data-divider-dark');
            const lightUrl = container.getAttribute('data-divider-light');
            img.src =
              e.detail.theme === 'light'
                ? darkUrl || '/divider.svg'
                : lightUrl || '/divider-light.svg';
          } else {
            img.src = e.detail.theme === 'light' ? '/divider.svg' : '/divider-light.svg';
          }
        });
      });

      // Also watch for data-theme attribute changes as a fallback
      const observer = new MutationObserver(() => {
        dividerImages.forEach((img) => {
          updateDivider(img);
        });
      });

      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-theme'],
      });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDivider);
    } else {
      // DOM is already ready, but wait a bit for ThemeManager to initialize
      setTimeout(initDivider, 0);
    }
  })();
</script>
