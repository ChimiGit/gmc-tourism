---
import ThemeManager from '../ui/ThemeManager.astro';
import { getImageBaseUrl, getLinkUrl } from '../../utils/images';

// Get dynamic logo URLs
const logoImage = `${getImageBaseUrl()}/logo.svg`;
const logoLightImage = `${getImageBaseUrl()}/logo-light.svg`;
---

<header id="site-header" class="fixed top-0 left-0 z-55 w-full">
  <!-- Main Navbar -->
  <div
    id="navbar"
    class="relative z-55 flex w-full items-center justify-between px-4 py-2 transition-all duration-300 md:px-12"
  >
    <div
      id="logo-container"
      class="relative z-10"
      data-logo-dark={logoImage}
      data-logo-light={logoLightImage}
    >
      <a href={getLinkUrl('/')} class="relative block h-10 w-10 md:h-12 md:w-12">
        <img
          id="site-logo"
          src={logoLightImage}
          alt="GMC Tourism Logo"
          class="h-full w-full object-contain transition-all duration-300"
        />
      </a>
    </div>

    <div class="relative z-60 flex items-center gap-4">
      <ThemeManager />
      <button
        id="menu-toggle"
        class="relative z-60 cursor-pointer px-4 font-medium uppercase tracking-wider text-white transition-opacity hover:opacity-70"
        aria-label="Toggle menu"
      >
        Menu
      </button>
    </div>
  </div>

  <!-- Menu Overlay -->
  <div
    id="menu-overlay"
    class="pointer-events-none fixed top-0 right-0 z-51 h-full w-full bg-black text-white opacity-0 transition-all duration-300 md:w-1/2 lg:w-1/3"
    style="box-shadow: -10px 0 30px rgba(0,0,0,0.5); transform: translateX(100%);"
  >
    <div class="relative flex h-full flex-col">
      <!-- Background decoration -->
      <div
        id="menu-decoration"
        class="pointer-events-none absolute top-1/2 right-12 flex -translate-y-1/2 flex-col items-center gap-6 select-none"
        style="z-index: 1;"
      >
        <span
          class="text-[15vw] font-bold leading-[0.8] tracking-tight text-white opacity-10 md:text-[12vw] lg:text-[8vw]"
        >
          G
        </span>
        <span
          class="text-[15vw] font-bold leading-[0.8] tracking-tight text-white opacity-10 md:text-[12vw] lg:text-[8vw]"
        >
          M
        </span>
        <span
          class="text-[15vw] font-bold leading-[0.8] tracking-tight text-white opacity-10 md:text-[12vw] lg:text-[8vw]"
        >
          C
        </span>
      </div>

      <!-- Close button -->
      <div
        class="flex justify-end px-6 py-6 md:px-12 relative"
        style="z-index: 999; pointer-events: auto; position: relative;"
      >
        <button
          id="menu-close"
          class="text-white transition-opacity hover:opacity-70 cursor-pointer relative"
          aria-label="Close menu"
          type="button"
          style="z-index: 1000; cursor: pointer; pointer-events: auto; position: relative; background: transparent; border: none; padding: 8px; min-width: 48px; min-height: 48px;"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="pointer-events: none; display: block;"
          >
            <path d="M18 6 6 18"></path>
            <path d="m6 6 12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Menu Content -->
      <div class="relative flex flex-1 flex-col justify-center px-6 md:px-12" style="z-index: 10;">
        <nav id="menu-items" class="space-y-4 md:space-y-6">
          <div class="menu-item overflow-hidden">
            <a
              href={getLinkUrl('/')}
              class="relative block rounded-lg px-3 py-2 text-4xl font-bold text-gray-400 transition-all duration-200 hover:text-white"
            >
              Home
            </a>
          </div>

          <div class="menu-item overflow-hidden">
            <a
              href={getLinkUrl('/about')}
              class="relative block rounded-lg px-3 py-2 text-4xl font-bold text-gray-400 transition-all duration-200 hover:text-white"
            >
              About
            </a>
          </div>

          <div class="menu-item overflow-hidden">
            <a
              href={getLinkUrl('/experiences')}
              class="relative block rounded-lg px-3 py-2 text-4xl font-bold text-gray-400 transition-all duration-200 hover:text-white"
            >
              Experiences
            </a>
          </div>

          <div class="menu-item overflow-hidden">
            <a
              href={getLinkUrl('/events')}
              class="relative block rounded-lg px-3 py-2 text-4xl font-bold text-gray-400 transition-all duration-200 hover:text-white"
            >
              Events Calendar
            </a>
          </div>

          <div class="menu-item overflow-hidden">
            <a
              href={getLinkUrl('/projects')}
              class="relative block rounded-lg px-3 py-2 text-4xl font-bold text-gray-400 transition-all duration-200 hover:text-white"
            >
              Projects
            </a>
          </div>

          <div class="menu-item overflow-hidden">
            <a
              href={getLinkUrl('/gallery')}
              class="relative block rounded-lg px-3 py-2 text-4xl font-bold text-gray-400 transition-all duration-200 hover:text-white"
            >
              Gallery
            </a>
          </div>

          <div class="menu-item overflow-hidden">
            <a
              href={getLinkUrl('/resources')}
              class="relative block rounded-lg px-3 py-2 text-4xl font-bold text-gray-400 transition-all duration-200 hover:text-white"
            >
              Resources
            </a>
          </div>

          <div class="menu-item overflow-hidden">
            <a
              href={getLinkUrl('/contact')}
              class="relative block rounded-lg px-3 py-2 text-4xl font-bold text-gray-400 transition-all duration-200 hover:text-white"
            >
              Contact
            </a>
          </div>
        </nav>
      </div>
    </div>
  </div>

  <!-- Overlay backdrop -->
  <div
    id="menu-backdrop"
    class="fixed inset-0 z-40 hidden bg-black/50 transition-opacity duration-300"
    style="cursor: pointer;"
  >
  </div>
</header>

<script>
  (function () {
    let isMenuOpen = false;
    let isInitialized = false;

    function openMenu() {
      const menuOverlay = document.getElementById('menu-overlay');
      const menuBackdrop = document.getElementById('menu-backdrop');
      const navbar = document.getElementById('navbar');
      const menuClose = document.getElementById('menu-close');
      const closeButtonContainer = menuClose?.parentElement;

      isMenuOpen = true;
      if (menuOverlay && menuBackdrop) {
        menuOverlay.classList.remove('pointer-events-none', 'opacity-0');
        menuOverlay.classList.add('pointer-events-auto', 'opacity-100');
        menuOverlay.style.transform = 'translateX(0)';
        menuBackdrop.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Ensure close button and container are clickable
        if (menuClose) {
          menuClose.style.pointerEvents = 'auto';
          menuClose.style.cursor = 'pointer';
          menuClose.style.position = 'relative';
          menuClose.style.zIndex = '1000';
          menuClose.style.background = 'transparent';
          menuClose.style.border = 'none';
        }
        if (closeButtonContainer) {
          closeButtonContainer.style.pointerEvents = 'auto';
          closeButtonContainer.style.zIndex = '999';
          closeButtonContainer.style.position = 'relative';
        }

        // Ensure close button is ready when menu opens
        setTimeout(() => {
          const menuClose = document.getElementById('menu-close');
          if (menuClose) {
            menuClose.style.pointerEvents = 'auto';
            menuClose.style.cursor = 'pointer';
          }
        }, 50);

        // Hide navbar buttons when menu is open
        if (navbar) {
          const buttonsContainer = navbar.querySelector('.flex.items-center.gap-4');
          if (buttonsContainer) {
            (buttonsContainer as HTMLElement).style.opacity = '0';
            (buttonsContainer as HTMLElement).style.pointerEvents = 'none';
          }
        }

        // Animate menu items
        setTimeout(() => {
          const items = document.querySelectorAll('.menu-item');
          items.forEach((item, i) => {
            setTimeout(() => {
              (item as HTMLElement).style.opacity = '1';
              (item as HTMLElement).style.transform = 'translateX(0)';
            }, i * 80);
          });
        }, 100);
      }
    }

    function closeMenu() {
      const menuOverlay = document.getElementById('menu-overlay');
      const menuBackdrop = document.getElementById('menu-backdrop');
      const navbar = document.getElementById('navbar');

      isMenuOpen = false;
      if (menuOverlay && menuBackdrop) {
        menuOverlay.classList.add('pointer-events-none', 'opacity-0');
        menuOverlay.classList.remove('pointer-events-auto', 'opacity-100');
        menuOverlay.style.transform = 'translateX(100%)';
        menuBackdrop.classList.add('hidden');
        document.body.style.overflow = 'auto';

        // Show navbar buttons when menu is closed
        if (navbar) {
          const buttonsContainer = navbar.querySelector('.flex.items-center.gap-4');
          if (buttonsContainer) {
            (buttonsContainer as HTMLElement).style.opacity = '1';
            (buttonsContainer as HTMLElement).style.pointerEvents = 'auto';
          }
        }

        // Reset menu items
        const items = document.querySelectorAll('.menu-item');
        items.forEach((item) => {
          (item as HTMLElement).style.opacity = '0';
          (item as HTMLElement).style.transform = 'translateX(50px)';
        });
      }
    }

    function initMenuItems() {
      // Initialize menu items with hidden state
      const items = document.querySelectorAll('.menu-item');
      items.forEach((item) => {
        (item as HTMLElement).style.opacity = '0';
        (item as HTMLElement).style.transform = 'translateX(50px)';
        (item as HTMLElement).style.transition = 'opacity 0.5s, transform 0.5s';
      });

      // Ensure buttons container has transition
      const navbar = document.getElementById('navbar');
      if (navbar) {
        const buttonsContainer = navbar.querySelector('.flex.items-center.gap-4');
        if (buttonsContainer) {
          (buttonsContainer as HTMLElement).style.transition = 'opacity 0.3s ease';
        }
      }
    }

    function initHeader() {
      // Only add event listener once using event delegation
      if (!isInitialized) {
        // Add direct event listener to menu toggle
        const menuToggleBtn = document.getElementById('menu-toggle');
        if (menuToggleBtn) {
          // Ensure button is clickable
          menuToggleBtn.style.pointerEvents = 'auto';
          menuToggleBtn.style.cursor = 'pointer';

          menuToggleBtn.addEventListener(
            'click',
            (e) => {
              e.preventDefault();
              e.stopPropagation();
              if (isMenuOpen) {
                closeMenu();
              } else {
                openMenu();
              }
            },
            false
          ); // Use bubble phase
        }

        // Use event delegation for menu items and backdrop
        document.addEventListener(
          'click',
          (e) => {
            const target = e.target as HTMLElement;

            // Check for close button - handle it first (check multiple ways to be sure)
            const menuClose = document.getElementById('menu-close');
            const isCloseButton =
              target.id === 'menu-close' ||
              target.closest('#menu-close') ||
              (menuClose &&
                (target === menuClose ||
                  menuClose.contains(target) ||
                  target.parentElement === menuClose));

            if (isCloseButton) {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              closeMenu();
              return false;
            }

            // Don't handle menu toggle here - let the direct listener handle it
            // Check for backdrop
            if (target.closest('#menu-backdrop')) {
              e.preventDefault();
              closeMenu();
              return;
            }

            // Check for submenu toggle
            const submenuToggle = target.closest('.submenu-toggle');
            if (submenuToggle) {
              e.preventDefault();
              const submenuId = submenuToggle.getAttribute('data-submenu');
              const submenuContent = document.querySelector(
                `[data-submenu-content="${submenuId}"]`
              );
              if (submenuContent) {
                submenuContent.classList.toggle('hidden');
              }
              return;
            }

            // Check for menu links
            if (target.closest('#menu-items a')) {
              closeMenu();
              return;
            }
          },
          false
        ); // Use bubble phase, not capture

        isInitialized = true;
      }

      // Re-initialize menu items on each page load
      initMenuItems();
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHeader);
    } else {
      initHeader();
    }

    // Re-initialize after View Transitions
    document.addEventListener('astro:after-swap', () => {
      isMenuOpen = false; // Reset menu state
      closeMenu(); // Ensure menu is closed
      // Ensure buttons are visible after transition
      const navbar = document.getElementById('navbar');
      if (navbar) {
        const buttonsContainer = navbar.querySelector('.flex.items-center.gap-4');
        if (buttonsContainer) {
          (buttonsContainer as HTMLElement).style.opacity = '1';
          (buttonsContainer as HTMLElement).style.pointerEvents = 'auto';
        }
      }
      isInitialized = false; // Reset initialization flag to re-attach listeners
      initHeader(); // Re-initialize menu items and listeners
    });

    // Also handle page load event
    document.addEventListener('astro:page-load', () => {
      isMenuOpen = false;
      closeMenu();
      // Ensure buttons are visible after page load
      const navbar = document.getElementById('navbar');
      if (navbar) {
        const buttonsContainer = navbar.querySelector('.flex.items-center.gap-4');
        if (buttonsContainer) {
          (buttonsContainer as HTMLElement).style.opacity = '1';
          (buttonsContainer as HTMLElement).style.pointerEvents = 'auto';
        }
      }
      isInitialized = false; // Reset initialization flag to re-attach listeners
      initHeader();
    });
  })();
</script>
