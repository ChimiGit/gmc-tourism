---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { getImageBaseUrl, getLinkUrl } from '../../utils/images';

export async function getStaticPaths() {
  const galleries = await getCollection('gallery');
  return galleries.map((gallery) => ({
    params: { slug: gallery.slug },
    props: { gallery },
  }));
}

const { gallery } = Astro.props;
const { title, description, images: rawImages } = gallery.data;

// Process images with dynamic URLs
const images = rawImages.map((image: { src: string; alt?: string; title?: string }) => ({
  ...image,
  src: `${getImageBaseUrl()}${image.src}`,
}));
---

<Layout title={`${title} | Gallery`} description={description} mainClass="pt-0">
  <!-- Hero/Header -->
  <div class="relative h-[40vh] w-full overflow-hidden flex items-center justify-center">
    <img
      src={`${getImageBaseUrl()}${gallery.data.coverImage}`}
      alt={title}
      class="absolute h-full w-full object-cover"
    />
    <div class="absolute inset-0 z-10 bg-linear-to-b from-black/50 via-black/30 to-black/60"></div>
    <div class="relative z-10 text-center px-4 max-w-4xl mx-auto">
      <h1 class="gallery-page-title text-3xl font-normal text-white md:text-4xl lg:text-5xl mb-4">
        {title}
      </h1>
      <p class="gallery-page-description text-lg text-white">{description}</p>
      <div class="gallery-page-meta mt-6 flex items-center justify-center gap-4 text-sm text-white">
        <span><i class="fa-regular fa-images mr-2"></i>{images.length} photos</span>
        {
          gallery.data.date && (
            <span>
              <i class="fa-regular fa-calendar mr-2" />
              {gallery.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}
            </span>
          )
        }
      </div>
      <a
        href={getLinkUrl('/gallery')}
        class="back-to-gallery-link inline-block mt-8 text-sm text-white hover:text-blue-400 transition-colors"
      >
        <i class="fa-solid fa-arrow-left mr-2 text-white"></i> Back to Gallery
      </a>
    </div>

    <!-- Bottom gradient fade -->
    <div
      class="absolute bottom-0 left-0 right-0 z-20 h-16"
      style="background: linear-gradient(to top, #000000, transparent);"
    >
    </div>
  </div>

  <!-- Images Grid -->
  <section class="gallery-images-section pt-16 pb-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {
          images.map((image, index) => (
            <button
              class="gallery-item group relative block overflow-hidden rounded-xl bg-gray-900 aspect-4/3 transition-transform hover:-translate-y-1 cursor-pointer focus:outline-none"
              data-index={index}
              aria-label={`View ${image.title || 'image'}`}
            >
              <img
                src={image.src}
                alt={image.alt || image.title || ''}
                class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110 opacity-80 group-hover:opacity-100"
                loading="lazy"
              />
              <div class="absolute inset-0 bg-linear-to-t from-black/90 via-black/20 to-transparent" />
              {image.title && (
                <div class="absolute bottom-0 left-0 p-6 w-full">
                  <h2 class="gallery-card-title text-xl font-bold text-white mb-2">
                    {image.title}
                  </h2>
                </div>
              )}
            </button>
          ))
        }
      </div>
    </div>
  </section>

  <!-- Lightbox Modal -->
  <dialog
    id="lightbox"
    class="lightbox-modal fixed inset-0 z-50 h-full w-full max-w-none max-h-none p-0 m-0 border-none open:flex flex-col hidden"
  >
    <!-- Close Button - Top Right -->
    <button
      id="lightbox-close"
      class="lightbox-close-btn fixed top-6 right-6 z-30 w-12 h-12 flex items-center justify-center rounded-full transition-all duration-300"
      title="Close (Esc)"
    >
      <i class="fa-solid fa-xmark text-2xl"></i>
    </button>

    <!-- Counter - Top Left -->
    <div class="fixed top-6 left-6 z-30">
      <span
        id="lightbox-counter"
        class="lightbox-counter text-sm font-medium tracking-wider opacity-70"></span>
    </div>

    <!-- Action Buttons - Top Center -->
    <div class="fixed top-6 left-1/2 -translate-x-1/2 z-30 flex items-center gap-1">
      <button
        id="lightbox-zoom"
        class="lightbox-action-btn w-10 h-10 flex items-center justify-center rounded-full transition-all duration-300"
        title="Toggle Zoom"
      >
        <i class="fa-solid fa-magnifying-glass-plus text-sm"></i>
      </button>
      <a
        id="lightbox-download"
        href="#"
        download
        class="lightbox-action-btn w-10 h-10 flex items-center justify-center rounded-full transition-all duration-300"
        title="Download"
      >
        <i class="fa-solid fa-download text-sm"></i>
      </a>
      <button
        id="lightbox-share"
        class="lightbox-action-btn w-10 h-10 flex items-center justify-center rounded-full transition-all duration-300"
        title="Share"
      >
        <i class="fa-solid fa-share-nodes text-sm"></i>
      </button>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex items-center justify-center h-full w-full overflow-hidden group">
      <!-- Navigation Button - Previous -->
      <button
        id="prev-btn"
        class="lightbox-nav-btn fixed left-6 top-1/2 -translate-y-1/2 w-14 h-14 flex items-center justify-center rounded-full z-20 opacity-0 group-hover:opacity-100 transition-all duration-300 hidden md:flex"
      >
        <i class="fa-solid fa-chevron-left text-lg"></i>
      </button>

      <!-- Navigation Button - Next -->
      <button
        id="next-btn"
        class="lightbox-nav-btn fixed right-6 top-1/2 -translate-y-1/2 w-14 h-14 flex items-center justify-center rounded-full z-20 opacity-0 group-hover:opacity-100 transition-all duration-300 hidden md:flex"
      >
        <i class="fa-solid fa-chevron-right text-lg"></i>
      </button>

      <!-- Image Container -->
      <div
        class="w-full h-full flex items-center justify-center pt-16 pb-24 px-4 md:px-16 md:pt-20 md:pb-28 md:px-20 touch-none"
        id="image-container"
      >
        <img
          id="lightbox-image"
          src=""
          alt=""
          class="lightbox-image max-h-full max-w-full object-contain transition-all duration-300 cursor-zoom-in rounded-lg shadow-2xl"
        />
      </div>
    </div>

    <!-- Image Title - Bottom Center -->
    <div class="lightbox-title-container fixed bottom-0 left-0 right-0 z-30 text-center px-4 py-6">
      <h2 id="lightbox-title" class="lightbox-title text-lg font-medium"></h2>
      <p id="lightbox-desc" class="lightbox-desc text-sm mt-1 line-clamp-2 hidden"></p>
    </div>

    <!-- Hidden elements for JS compatibility -->
    <div class="hidden">
      <p id="lightbox-location"><span></span></p>
      <p id="lightbox-source"><span></span></p>
      <p id="lightbox-rights"><span></span></p>
      <div id="lightbox-sidebar"></div>
      <div id="mobile-info-overlay">
        <h2 id="mobile-lightbox-title"></h2>
        <p id="mobile-lightbox-desc"></p>
        <span id="mobile-lightbox-location"></span>
        <span id="mobile-lightbox-source"></span>
        <button id="close-mobile-info"></button>
      </div>
      <button id="toggle-mobile-info"></button>
    </div>
  </dialog>
</Layout>

<style>
  dialog::backdrop {
    background: transparent;
  }

  dialog[open] {
    display: flex !important; /* Override hidden */
  }

  /* Gallery hero text - keep white in both themes (over image) */
  .gallery-page-title,
  .gallery-page-description,
  .gallery-page-meta {
    color: #ffffff !important;
  }

  :global([data-theme='light']) .gallery-page-title,
  :global([data-theme='light']) .gallery-page-description,
  :global([data-theme='light']) .gallery-page-meta {
    color: #ffffff !important;
  }

  /* Back to Gallery link - keep white in both themes */
  .back-to-gallery-link {
    color: #ffffff !important;
  }

  :global([data-theme='light']) .back-to-gallery-link {
    color: #ffffff !important;
  }

  /* Back to Gallery icon - keep white in both themes */
  .back-to-gallery-link i {
    color: #ffffff !important;
  }

  :global([data-theme='light']) .back-to-gallery-link i {
    color: #ffffff !important;
  }

  /* Gallery content section - theme aware */
  .gallery-content-section {
    --gallery-content-bg: transparent;
    --gallery-content-text: #ffffff;
    --gallery-content-border: rgba(255, 255, 255, 0.1);
    background: var(--gallery-content-bg);
    color: var(--gallery-content-text);
    border-color: var(--gallery-content-border);
  }

  :global([data-theme='light']) .gallery-content-section {
    --gallery-content-bg: #ffffff;
    --gallery-content-text: #111827;
    --gallery-content-border: rgba(0, 0, 0, 0.1);
  }

  /* Gallery images section - theme aware */
  .gallery-images-section {
    --gallery-images-bg: #000000;
    --gallery-images-text: #ffffff;
    background: var(--gallery-images-bg);
    color: var(--gallery-images-text);
  }

  :global([data-theme='light']) .gallery-images-section {
    background-color: transparent;
    color: #0f172a;
  }

  :global([data-theme='light']) .gallery-item {
    background-color: #e2e8f0;
  }

  /* Icons in gallery section - theme aware */
  .gallery-images-section i {
    color: #ffffff;
  }

  :global([data-theme='light']) .gallery-images-section i {
    color: #000000 !important;
  }

  /* Gallery page meta icons - keep white in both themes */
  .gallery-page-meta i {
    color: #ffffff !important;
  }

  :global([data-theme='light']) .gallery-page-meta i {
    color: #ffffff !important;
  }

  /* Gallery card text - keep white in both themes */
  .gallery-card-title,
  .gallery-card-text {
    color: #ffffff !important;
  }

  :global([data-theme='light']) .gallery-card-title,
  :global([data-theme='light']) .gallery-card-text {
    color: #ffffff !important;
  }

  :global([data-theme='light']) .gallery-item {
    background-color: #e2e8f0;
  }

  /* Lightbox Modal - Modern Design */
  .lightbox-modal {
    background: rgba(0, 0, 0, 0.95);
    color: #ffffff;
  }

  :global([data-theme='light']) .lightbox-modal {
    background: rgba(255, 255, 255, 0.98);
    color: #111827;
  }

  .lightbox-modal::backdrop {
    background: transparent;
  }

  /* Close Button */
  .lightbox-close-btn {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px);
    color: #ffffff;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .lightbox-close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
  }

  :global([data-theme='light']) .lightbox-close-btn {
    background: rgba(0, 0, 0, 0.05);
    color: #111827;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  :global([data-theme='light']) .lightbox-close-btn:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  /* Action Buttons */
  .lightbox-action-btn {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(12px);
    color: #ffffff;
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .lightbox-action-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: scale(1.05);
  }

  :global([data-theme='light']) .lightbox-action-btn {
    background: rgba(0, 0, 0, 0.05);
    color: #111827;
    border: 1px solid rgba(0, 0, 0, 0.08);
  }

  :global([data-theme='light']) .lightbox-action-btn:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  /* Navigation Buttons */
  .lightbox-nav-btn {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px);
    color: #ffffff;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .lightbox-nav-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-50%) scale(1.05);
  }

  :global([data-theme='light']) .lightbox-nav-btn {
    background: rgba(0, 0, 0, 0.05);
    color: #111827;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  :global([data-theme='light']) .lightbox-nav-btn:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  /* Hide navigation buttons on mobile */
  @media (max-width: 768px) {
    .lightbox-nav-btn {
      display: none !important;
    }
  }

  /* Image */
  .lightbox-image {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  }

  :global([data-theme='light']) .lightbox-image {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  /* Counter */
  .lightbox-counter {
    color: rgba(255, 255, 255, 0.7);
  }

  :global([data-theme='light']) .lightbox-counter {
    color: rgba(0, 0, 0, 0.5);
  }

  /* Title Container */
  .lightbox-title-container {
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.8) 0%,
      rgba(0, 0, 0, 0.4) 60%,
      transparent 100%
    );
  }

  :global([data-theme='light']) .lightbox-title-container {
    background: linear-gradient(
      to top,
      rgba(255, 255, 255, 0.95) 0%,
      rgba(255, 255, 255, 0.7) 60%,
      transparent 100%
    );
  }

  /* Title and Description */
  .lightbox-title {
    color: #ffffff;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  .lightbox-desc {
    color: rgba(255, 255, 255, 0.8);
  }

  :global([data-theme='light']) .lightbox-title {
    color: #111827;
    text-shadow: none;
  }

  :global([data-theme='light']) .lightbox-desc {
    color: rgba(0, 0, 0, 0.6);
  }

  /* Icons */
  .lightbox-modal i {
    color: inherit;
  }
</style>

<script is:inline define:vars={{ images }}>
  // Gallery Logic
  const lightbox = document.getElementById('lightbox');
  const items = document.querySelectorAll('.gallery-item');
  const imgEl = document.getElementById('lightbox-image');
  const titleEl = document.getElementById('lightbox-title');
  const descEl = document.getElementById('lightbox-desc');
  const locEl = document.querySelector('#lightbox-location span');
  const sourceEl = document.querySelector('#lightbox-source span');
  const rightsEl = document.querySelector('#lightbox-rights span');
  const downloadBtn = document.getElementById('lightbox-download');
  const counterEl = document.getElementById('lightbox-counter');

  // Mobile elements
  const mobileTitle = document.getElementById('mobile-lightbox-title');
  const mobileDesc = document.getElementById('mobile-lightbox-desc');
  const mobileLoc = document.getElementById('mobile-lightbox-location');
  const mobileSource = document.getElementById('mobile-lightbox-source');

  let currentIndex = 0;
  let zoomLevel = 1;

  // Touch/swipe variables
  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;
  let isSwiping = false;

  // Open Lightbox
  items.forEach((item) => {
    item.addEventListener('click', () => {
      const index = parseInt(item.dataset.index);
      openLightbox(index);
    });
  });

  function openLightbox(index) {
    currentIndex = index;
    updateLightboxContent();
    lightbox.showModal();
    document.body.style.overflow = 'hidden'; // Prevent scrolling background
  }

  function closeLightbox() {
    lightbox.close();
    document.body.style.overflow = '';
    resetZoom();
  }

  function updateLightboxContent() {
    const data = images[currentIndex];

    // Update Image
    imgEl.src = data.src;
    imgEl.alt = data.alt || data.title || '';

    // Update Title
    titleEl.textContent = data.title || '';

    // Update Description (show only if exists)
    if (data.description) {
      descEl.textContent = data.description;
      descEl.classList.remove('hidden');
    } else {
      descEl.classList.add('hidden');
    }

    // Update hidden elements for compatibility
    locEl.textContent = data.location || '';
    sourceEl.textContent = data.source || '';
    rightsEl.textContent = data.rights || '';
    mobileTitle.textContent = data.title || '';
    mobileDesc.textContent = data.description || '';
    mobileLoc.textContent = data.location || '';
    mobileSource.textContent = data.source || '';

    // Update Buttons
    downloadBtn.href = data.src;
    counterEl.textContent = `${currentIndex + 1} / ${images.length}`;

    // Reset Zoom
    resetZoom();
  }

  function nextImage() {
    currentIndex = (currentIndex + 1) % images.length;
    updateLightboxContent();
  }

  function prevImage() {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    updateLightboxContent();
  }

  const imgContainer = document.getElementById('image-container');

  // Zoom Logic
  function toggleZoom() {
    if (zoomLevel === 1) {
      zoomLevel = 2; // logical state
      imgEl.classList.remove('max-h-full', 'max-w-full');
      imgEl.style.height = 'auto';
      imgEl.style.width = 'auto';
      imgEl.style.maxHeight = 'none';
      imgEl.style.maxWidth = 'none';

      // If natural size is smaller than container, force it larger to simulate zoom
      if (
        imgEl.naturalWidth < imgContainer.clientWidth &&
        imgEl.naturalHeight < imgContainer.clientHeight
      ) {
        imgEl.style.height = '200%';
        imgEl.style.width = 'auto';
      }

      imgContainer.classList.remove('overflow-hidden');
      imgContainer.classList.add('overflow-auto', 'flex-start'); // flex-start to allow scrolling from top-left

      imgEl.style.cursor = 'zoom-out';
    } else {
      resetZoom();
    }
  }

  function resetZoom() {
    zoomLevel = 1;
    imgEl.classList.add('max-h-full', 'max-w-full');
    imgEl.style.height = '';
    imgEl.style.width = '';
    imgEl.style.maxHeight = '';
    imgEl.style.maxWidth = '';

    imgContainer.classList.add('overflow-hidden');
    imgContainer.classList.remove('overflow-auto', 'flex-start');

    imgEl.style.cursor = 'zoom-in';
  }

  // Event Listeners
  document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
  document.getElementById('next-btn').addEventListener('click', nextImage);
  document.getElementById('prev-btn').addEventListener('click', prevImage);
  document.getElementById('lightbox-zoom').addEventListener('click', toggleZoom);
  imgEl.addEventListener('click', toggleZoom); // Click image to zoom also

  // Mobile Info Toggle
  const mobileOverlay = document.getElementById('mobile-info-overlay');
  const toggleInfoBtn = document.getElementById('toggle-mobile-info');
  const closeInfoBtn = document.getElementById('close-mobile-info');

  toggleInfoBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    mobileOverlay.classList.remove('translate-y-full');
  });

  closeInfoBtn.addEventListener('click', () => {
    mobileOverlay.classList.add('translate-y-full');
  });

  // Close on clicking outside image (on background)
  document.getElementById('image-container').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      closeLightbox();
    }
  });

  // Keyboard Navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox.open) return;

    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowRight') nextImage();
    if (e.key === 'ArrowLeft') prevImage();
  });

  // Touch/Swipe Navigation for Mobile
  const imageContainer = document.getElementById('image-container');
  const lightboxImage = document.getElementById('lightbox-image');

  imageContainer.addEventListener(
    'touchstart',
    (e) => {
      if (zoomLevel > 1) return; // Don't swipe when zoomed in
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isSwiping = false;
    },
    { passive: true }
  );

  imageContainer.addEventListener(
    'touchmove',
    (e) => {
      if (zoomLevel > 1) return; // Allow scrolling when zoomed in

      touchEndX = e.touches[0].clientX;
      touchEndY = e.touches[0].clientY;

      const deltaX = Math.abs(touchEndX - touchStartX);
      const deltaY = Math.abs(touchEndY - touchStartY);

      // Determine if this is a horizontal swipe (more horizontal than vertical)
      if (deltaX > deltaY && deltaX > 20) {
        isSwiping = true;
        e.preventDefault(); // Prevent scrolling when swiping horizontally
      }
    },
    { passive: false }
  );

  imageContainer.addEventListener(
    'touchend',
    () => {
      if (zoomLevel > 1) {
        // Reset when zoomed in
        isSwiping = false;
        touchStartX = 0;
        touchStartY = 0;
        touchEndX = 0;
        touchEndY = 0;
        return;
      }

      if (!isSwiping) {
        touchStartX = 0;
        touchStartY = 0;
        touchEndX = 0;
        touchEndY = 0;
        return;
      }

      const deltaX = touchEndX - touchStartX;
      const minSwipeDistance = 50; // Minimum distance for a swipe

      // Check if it's a horizontal swipe
      if (Math.abs(deltaX) > minSwipeDistance) {
        if (deltaX > 0) {
          // Swipe right - go to previous image
          prevImage();
        } else {
          // Swipe left - go to next image
          nextImage();
        }
      }

      // Reset
      isSwiping = false;
      touchStartX = 0;
      touchStartY = 0;
      touchEndX = 0;
      touchEndY = 0;
    },
    { passive: true }
  );

  // Also handle swipe on the image itself
  lightboxImage.addEventListener(
    'touchstart',
    (e) => {
      if (zoomLevel > 1) return;
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isSwiping = false;
    },
    { passive: true }
  );

  lightboxImage.addEventListener(
    'touchmove',
    (e) => {
      if (zoomLevel > 1) return;

      touchEndX = e.touches[0].clientX;
      touchEndY = e.touches[0].clientY;

      const deltaX = Math.abs(touchEndX - touchStartX);
      const deltaY = Math.abs(touchEndY - touchStartY);

      if (deltaX > deltaY && deltaX > 20) {
        isSwiping = true;
        e.preventDefault();
      }
    },
    { passive: false }
  );

  lightboxImage.addEventListener(
    'touchend',
    () => {
      if (zoomLevel > 1 || !isSwiping) {
        isSwiping = false;
        touchStartX = 0;
        touchStartY = 0;
        touchEndX = 0;
        touchEndY = 0;
        return;
      }

      const deltaX = touchEndX - touchStartX;
      const minSwipeDistance = 50;

      if (Math.abs(deltaX) > minSwipeDistance) {
        if (deltaX > 0) {
          prevImage();
        } else {
          nextImage();
        }
      }

      isSwiping = false;
      touchStartX = 0;
      touchStartY = 0;
      touchEndX = 0;
      touchEndY = 0;
    },
    { passive: true }
  );

  // Share functionality
  document.getElementById('lightbox-share').addEventListener('click', async () => {
    const data = images[currentIndex];
    if (navigator.share) {
      try {
        await navigator.share({
          title: data.title || 'GMC Tourism Gallery',
          text: data.description || 'Check out this image from GMC Tourism',
          url: window.location.href,
        });
      } catch (err) {
        console.error('Share failed:', err);
      }
    } else {
      // Fallback
      alert('Sharing is not supported on this browser. URL copied to clipboard.');
      navigator.clipboard.writeText(window.location.href);
    }
  });
</script>
