---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { getImageBaseUrl } from '../../utils/images';

export async function getStaticPaths() {
  const galleries = await getCollection('gallery');
  return galleries.map((gallery) => ({
    params: { slug: gallery.slug },
    props: { gallery },
  }));
}

const { gallery } = Astro.props;
const { title, description, images: rawImages } = gallery.data;

// Process images with dynamic URLs
const images = rawImages.map((image: { src: string; alt?: string; title?: string }) => ({
  ...image,
  src: `${getImageBaseUrl()}${image.src}`,
}));
---

<Layout title={`${title} | Gallery`} description={description} mainClass="pt-0">
  <!-- Hero/Header -->
  <div class="relative h-[40vh] w-full overflow-hidden flex items-center justify-center">
    <img src={`${getImageBaseUrl()}${gallery.data.coverImage}`} alt={title} class="absolute h-full w-full object-cover" />
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative z-10 text-center px-4 max-w-4xl mx-auto">
      <h1 class="gallery-page-title text-3xl font-bold text-white md:text-4xl lg:text-5xl mb-4">
        {title}
      </h1>
      <p class="gallery-page-description text-lg text-white">{description}</p>
      <div class="gallery-page-meta mt-6 flex items-center justify-center gap-4 text-sm text-white">
        <span><i class="fa-regular fa-images mr-2"></i>{images.length} photos</span>
        {
          gallery.data.date && (
            <span>
              <i class="fa-regular fa-calendar mr-2" />
              {gallery.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}
            </span>
          )
        }
      </div>
      <a
        href="/gallery"
        class="inline-block mt-8 text-sm text-white hover:text-blue-400 transition-colors"
      >
        <i class="fa-solid fa-arrow-left mr-2 text-white"></i> Back to Gallery
      </a>
    </div>
  </div>

  <!-- Images Grid -->
  <section class="gallery-images-section py-16 px-4 sm:px-6 lg:px-8 min-h-screen">
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {
          images.map((image, index) => (
            <button
              class="gallery-item group relative aspect-square overflow-hidden rounded-lg cursor-pointer focus:outline-none"
              data-index={index}
              aria-label={`View ${image.title || 'image'}`}
            >
              <img
                src={image.src}
                alt={image.alt || image.title || ''}
                class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110 opacity-90 group-hover:opacity-100"
                loading="lazy"
              />
              <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors" />
              <div class="absolute bottom-0 left-0 right-0 p-2 bg-linear-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                {image.title && (
                  <p class="gallery-image-title text-xs font-medium truncate text-white px-2">
                    {image.title}
                  </p>
                )}
              </div>
            </button>
          ))
        }
      </div>
    </div>
  </section>

  <!-- Lightbox Modal -->
  <dialog
    id="lightbox"
    class="lightbox-modal fixed inset-0 z-50 h-full w-full max-w-none max-h-none p-0 m-0 border-none open:flex flex-col hidden"
  >
    <!-- Toolbar -->
    <div
      class="lightbox-toolbar flex items-center justify-between p-4 backdrop-blur-sm z-20 absolute top-0 left-0 right-0"
    >
      <div class="flex items-center gap-4">
        <span id="lightbox-counter" class="lightbox-counter text-sm font-medium"></span>
      </div>
      <div class="flex items-center gap-2">
        <button
          id="lightbox-zoom"
          class="lightbox-button p-2 rounded-full transition-colors"
          title="Toggle Zoom"
        >
          <i class="fa-solid fa-magnifying-glass-plus"></i>
        </button>
        <button
          id="lightbox-share"
          class="lightbox-button p-2 rounded-full transition-colors"
          title="Share"
        >
          <i class="fa-solid fa-share-nodes"></i>
        </button>
        <a
          id="lightbox-download"
          href="#"
          download
          class="lightbox-button p-2 rounded-full transition-colors"
          title="Download"
        >
          <i class="fa-solid fa-download"></i>
        </a>
        <button
          id="lightbox-close"
          class="lightbox-button p-2 rounded-full transition-colors ml-2"
          title="Close"
        >
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col md:flex-row h-full overflow-hidden pt-16">
      <!-- Image Area -->
      <div
        class="lightbox-image-area relative flex-1 flex items-center justify-center h-full overflow-hidden group"
      >
        <!-- Navigation Buttons -->
        <button
          id="prev-btn"
          class="lightbox-nav-button absolute left-4 top-1/2 -translate-y-1/2 p-4 rounded-full z-10 opacity-0 group-hover:opacity-100 transition-opacity"
        >
          <i class="fa-solid fa-chevron-left text-xl"></i>
        </button>
        <button
          id="next-btn"
          class="lightbox-nav-button absolute right-4 top-1/2 -translate-y-1/2 p-4 rounded-full z-10 opacity-0 group-hover:opacity-100 transition-opacity"
        >
          <i class="fa-solid fa-chevron-right text-xl"></i>
        </button>

        <!-- The Image -->
        <div
          class="w-full h-full flex items-center justify-center overflow-hidden"
          id="image-container"
        >
          <img
            id="lightbox-image"
            src=""
            alt=""
            class="max-h-full max-w-full object-contain transition-transform duration-200 cursor-zoom-in"
          />
        </div>
      </div>

      <!-- Sidebar (Metadata) -->
      <div
        class="lightbox-sidebar w-full md:w-80 backdrop-blur border-t md:border-t-0 md:border-l p-6 overflow-y-auto shrink-0 hidden md:block"
        id="lightbox-sidebar"
      >
        <h2 id="lightbox-title" class="text-xl font-bold mb-4"></h2>

        <div class="space-y-6 text-sm">
          <div class="space-y-1">
            <h3 class="lightbox-label uppercase text-xs tracking-wide font-semibold">
              Description
            </h3>
            <p id="lightbox-desc" class="lightbox-text leading-relaxed"></p>
          </div>

          <div class="grid grid-cols-1 gap-4">
            <div class="space-y-1">
              <h3 class="lightbox-label uppercase text-xs tracking-wide font-semibold">Location</h3>
              <p id="lightbox-location" class="flex items-center gap-2">
                <i class="fa-solid fa-location-dot"></i>
                <span></span>
              </p>
            </div>

            <div class="space-y-1">
              <h3 class="lightbox-label uppercase text-xs tracking-wide font-semibold">Source</h3>
              <p id="lightbox-source" class="flex items-center gap-2">
                <i class="fa-solid fa-camera"></i>
                <span></span>
              </p>
            </div>

            <div class="space-y-1">
              <h3 class="lightbox-label uppercase text-xs tracking-wide font-semibold">Rights</h3>
              <p id="lightbox-rights" class="flex items-center gap-2">
                <i class="fa-solid fa-copyright"></i>
                <span></span>
              </p>
            </div>
          </div>
        </div>

        <!-- Mobile Sidebar Toggle (Info button equivalent) -->
        <div class="lightbox-footer mt-8 pt-6 border-t text-xs">Images provided by GMC Tourism</div>
      </div>

      <!-- Mobile Info Overlay (Initially hidden) -->
      <div
        id="mobile-info-overlay"
        class="mobile-lightbox-overlay absolute bottom-0 left-0 right-0 p-6 transform translate-y-full transition-transform duration-300 md:hidden z-20 max-h-[50vh] overflow-y-auto rounded-t-2xl"
      >
        <!-- Copied content from sidebar via JS or just simplified view -->
        <div class="flex justify-between items-start mb-4">
          <h2 id="mobile-lightbox-title" class="text-lg font-bold"></h2>
          <button id="close-mobile-info" class="p-1"
            ><i class="fa-solid fa-chevron-down"></i></button
          >
        </div>
        <p id="mobile-lightbox-desc" class="mobile-lightbox-text text-sm mb-4"></p>
        <div class="grid grid-cols-2 gap-4 text-xs">
          <div>
            <span class="mobile-lightbox-label block uppercase font-semibold">Location</span>
            <span id="mobile-lightbox-location"></span>
          </div>
          <div>
            <span class="mobile-lightbox-label block uppercase font-semibold">Source</span>
            <span id="mobile-lightbox-source"></span>
          </div>
        </div>
      </div>

      <!-- Mobile Info Toggle Button -->
      <button
        id="toggle-mobile-info"
        class="lightbox-mobile-button absolute bottom-6 right-6 p-3 rounded-full backdrop-blur md:hidden z-10"
      >
        <i class="fa-solid fa-circle-info text-xl"></i>
      </button>
    </div>
  </dialog>
</Layout>

<style>
  dialog::backdrop {
    background: rgba(0, 0, 0, 0.95);
  }

  dialog[open] {
    display: flex !important; /* Override hidden */
  }

  /* Gallery hero text - keep white in both themes (over image) */
  .gallery-page-title,
  .gallery-page-description,
  .gallery-page-meta {
    color: #ffffff !important;
  }

  :global([data-theme='light']) .gallery-page-title,
  :global([data-theme='light']) .gallery-page-description,
  :global([data-theme='light']) .gallery-page-meta {
    color: #ffffff !important;
  }

  /* Gallery content section - theme aware */
  .gallery-content-section {
    --gallery-content-bg: #000000;
    --gallery-content-text: #ffffff;
    --gallery-content-border: rgba(255, 255, 255, 0.1);
    background: var(--gallery-content-bg);
    color: var(--gallery-content-text);
    border-color: var(--gallery-content-border);
  }

  :global([data-theme='light']) .gallery-content-section {
    --gallery-content-bg: #ffffff;
    --gallery-content-text: #111827;
    --gallery-content-border: rgba(0, 0, 0, 0.1);
  }

  /* Gallery images section - theme aware */
  .gallery-images-section {
    --gallery-images-bg: #000000;
    --gallery-images-text: #ffffff;
    background: var(--gallery-images-bg);
    color: var(--gallery-images-text);
  }

  :global([data-theme='light']) .gallery-images-section {
    --gallery-images-bg: #ffffff;
    --gallery-images-text: #111827;
  }

  /* Gallery item - theme aware */
  .gallery-item {
    background-color: #111827;
  }

  :global([data-theme='light']) .gallery-item {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
  }

  /* Icons in gallery section - theme aware */
  .gallery-images-section i {
    color: #ffffff;
  }

  :global([data-theme='light']) .gallery-images-section i {
    color: #000000 !important;
  }

  /* Gallery page meta icons - keep white in both themes */
  .gallery-page-meta i {
    color: #ffffff !important;
  }

  :global([data-theme='light']) .gallery-page-meta i {
    color: #ffffff !important;
  }

  /* Gallery image title - keep white (overlay on image) */
  .gallery-image-title {
    color: #ffffff !important;
  }

  :global([data-theme='light']) .gallery-image-title {
    color: #ffffff !important;
  }

  /* Lightbox Modal - theme aware */
  .lightbox-modal {
    background: rgba(0, 0, 0, 0.95);
    color: #ffffff;
  }

  :global([data-theme='light']) .lightbox-modal {
    background: rgba(255, 255, 255, 0.98);
    color: #111827;
  }

  .lightbox-modal::backdrop {
    background: rgba(0, 0, 0, 0.9);
  }

  :global([data-theme='light']) .lightbox-modal::backdrop {
    background: rgba(0, 0, 0, 0.5);
  }

  /* Lightbox Toolbar */
  .lightbox-toolbar {
    background: rgba(0, 0, 0, 0.5);
  }

  :global([data-theme='light']) .lightbox-toolbar {
    background: rgba(255, 255, 255, 0.9);
    border-bottom: 1px solid #e5e7eb;
  }

  /* Lightbox Buttons */
  .lightbox-button {
    color: #ffffff;
  }

  .lightbox-button:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  :global([data-theme='light']) .lightbox-button {
    color: #111827;
  }

  :global([data-theme='light']) .lightbox-button:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  /* Lightbox Image Area */
  .lightbox-image-area {
    background: #000000;
  }

  :global([data-theme='light']) .lightbox-image-area {
    background: #f3f4f6;
  }

  /* Navigation Buttons */
  .lightbox-nav-button {
    background: rgba(0, 0, 0, 0.5);
    color: #ffffff;
  }

  .lightbox-nav-button:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  :global([data-theme='light']) .lightbox-nav-button {
    background: rgba(255, 255, 255, 0.9);
    color: #111827;
    border: 1px solid #e5e7eb;
  }

  :global([data-theme='light']) .lightbox-nav-button:hover {
    background: rgba(255, 255, 255, 1);
  }

  /* Lightbox Sidebar */
  .lightbox-sidebar {
    background: rgba(31, 41, 55, 0.95);
    border-color: rgb(55, 65, 81);
    color: #ffffff;
  }

  :global([data-theme='light']) .lightbox-sidebar {
    background: rgba(249, 250, 251, 0.98);
    border-color: #e5e7eb;
    color: #111827;
  }

  /* Lightbox Text Elements */
  .lightbox-counter,
  .lightbox-label,
  .lightbox-text,
  .lightbox-footer {
    color: #ffffff;
  }

  :global([data-theme='light']) .lightbox-counter,
  :global([data-theme='light']) .lightbox-label,
  :global([data-theme='light']) .lightbox-text,
  :global([data-theme='light']) .lightbox-footer {
    color: #111827;
  }

  .lightbox-footer {
    border-color: rgb(55, 65, 81);
  }

  :global([data-theme='light']) .lightbox-footer {
    border-color: #e5e7eb;
  }

  /* Lightbox Icons */
  .lightbox-modal i {
    color: #ffffff;
  }

  :global([data-theme='light']) .lightbox-modal i {
    color: #111827;
  }

  /* Mobile Lightbox Overlay */
  .mobile-lightbox-overlay {
    background: rgba(0, 0, 0, 0.9);
    color: #ffffff;
  }

  :global([data-theme='light']) .mobile-lightbox-overlay {
    background: rgba(255, 255, 255, 0.98);
    color: #111827;
    border-top: 1px solid #e5e7eb;
  }

  .mobile-lightbox-text,
  .mobile-lightbox-label {
    color: #ffffff;
  }

  :global([data-theme='light']) .mobile-lightbox-text,
  :global([data-theme='light']) .mobile-lightbox-label {
    color: #111827;
  }

  /* Mobile Info Toggle Button */
  .lightbox-mobile-button {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
  }

  .lightbox-mobile-button:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  :global([data-theme='light']) .lightbox-mobile-button {
    background: rgba(0, 0, 0, 0.05);
    color: #111827;
  }

  :global([data-theme='light']) .lightbox-mobile-button:hover {
    background: rgba(0, 0, 0, 0.1);
  }
</style>

<script is:inline define:vars={{ images }}>
  // Gallery Logic
  const lightbox = document.getElementById('lightbox');
  const items = document.querySelectorAll('.gallery-item');
  const imgEl = document.getElementById('lightbox-image');
  const titleEl = document.getElementById('lightbox-title');
  const descEl = document.getElementById('lightbox-desc');
  const locEl = document.querySelector('#lightbox-location span');
  const sourceEl = document.querySelector('#lightbox-source span');
  const rightsEl = document.querySelector('#lightbox-rights span');
  const downloadBtn = document.getElementById('lightbox-download');
  const counterEl = document.getElementById('lightbox-counter');

  // Mobile elements
  const mobileTitle = document.getElementById('mobile-lightbox-title');
  const mobileDesc = document.getElementById('mobile-lightbox-desc');
  const mobileLoc = document.getElementById('mobile-lightbox-location');
  const mobileSource = document.getElementById('mobile-lightbox-source');

  let currentIndex = 0;
  let zoomLevel = 1;

  // Open Lightbox
  items.forEach((item) => {
    item.addEventListener('click', () => {
      const index = parseInt(item.dataset.index);
      openLightbox(index);
    });
  });

  function openLightbox(index) {
    currentIndex = index;
    updateLightboxContent();
    lightbox.showModal();
    document.body.style.overflow = 'hidden'; // Prevent scrolling background
  }

  function closeLightbox() {
    lightbox.close();
    document.body.style.overflow = '';
    resetZoom();
  }

  function updateLightboxContent() {
    const data = images[currentIndex];

    // Update Image
    imgEl.src = data.src;
    imgEl.alt = data.alt || data.title || '';

    // Update Text (Desktop)
    titleEl.textContent = data.title || 'Untitled';
    descEl.textContent = data.description || 'No description available.';
    locEl.textContent = data.location || 'Unknown';
    sourceEl.textContent = data.source || 'Unknown';
    rightsEl.textContent = data.rights || 'Unknown';

    // Update Text (Mobile)
    mobileTitle.textContent = data.title || 'Untitled';
    mobileDesc.textContent = data.description || 'No description available.';
    mobileLoc.textContent = data.location || 'Unknown';
    mobileSource.textContent = data.source || 'Unknown';

    // Update Buttons
    downloadBtn.href = data.src;
    counterEl.textContent = `${currentIndex + 1} / ${images.length}`;

    // Reset Zoom
    resetZoom();
  }

  function nextImage() {
    currentIndex = (currentIndex + 1) % images.length;
    updateLightboxContent();
  }

  function prevImage() {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    updateLightboxContent();
  }

  const imgContainer = document.getElementById('image-container');

  // Zoom Logic
  function toggleZoom() {
    if (zoomLevel === 1) {
      zoomLevel = 2; // logical state
      imgEl.classList.remove('max-h-full', 'max-w-full');
      imgEl.style.height = 'auto';
      imgEl.style.width = 'auto';
      imgEl.style.maxHeight = 'none';
      imgEl.style.maxWidth = 'none';

      // If natural size is smaller than container, force it larger to simulate zoom
      if (
        imgEl.naturalWidth < imgContainer.clientWidth &&
        imgEl.naturalHeight < imgContainer.clientHeight
      ) {
        imgEl.style.height = '200%';
        imgEl.style.width = 'auto';
      }

      imgContainer.classList.remove('overflow-hidden');
      imgContainer.classList.add('overflow-auto', 'flex-start'); // flex-start to allow scrolling from top-left

      imgEl.style.cursor = 'zoom-out';
    } else {
      resetZoom();
    }
  }

  function resetZoom() {
    zoomLevel = 1;
    imgEl.classList.add('max-h-full', 'max-w-full');
    imgEl.style.height = '';
    imgEl.style.width = '';
    imgEl.style.maxHeight = '';
    imgEl.style.maxWidth = '';

    imgContainer.classList.add('overflow-hidden');
    imgContainer.classList.remove('overflow-auto', 'flex-start');

    imgEl.style.cursor = 'zoom-in';
  }

  // Event Listeners
  document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
  document.getElementById('next-btn').addEventListener('click', nextImage);
  document.getElementById('prev-btn').addEventListener('click', prevImage);
  document.getElementById('lightbox-zoom').addEventListener('click', toggleZoom);
  imgEl.addEventListener('click', toggleZoom); // Click image to zoom also

  // Mobile Info Toggle
  const mobileOverlay = document.getElementById('mobile-info-overlay');
  const toggleInfoBtn = document.getElementById('toggle-mobile-info');
  const closeInfoBtn = document.getElementById('close-mobile-info');

  toggleInfoBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    mobileOverlay.classList.remove('translate-y-full');
  });

  closeInfoBtn.addEventListener('click', () => {
    mobileOverlay.classList.add('translate-y-full');
  });

  // Close on clicking outside image (on background)
  document.getElementById('image-container').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      closeLightbox();
    }
  });

  // Keyboard Navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox.open) return;

    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowRight') nextImage();
    if (e.key === 'ArrowLeft') prevImage();
  });

  // Share functionality
  document.getElementById('lightbox-share').addEventListener('click', async () => {
    const data = images[currentIndex];
    if (navigator.share) {
      try {
        await navigator.share({
          title: data.title || 'GMC Tourism Gallery',
          text: data.description || 'Check out this image from GMC Tourism',
          url: window.location.href,
        });
      } catch (err) {
        console.error('Share failed:', err);
      }
    } else {
      // Fallback
      alert('Sharing is not supported on this browser. URL copied to clipboard.');
      navigator.clipboard.writeText(window.location.href);
    }
  });
</script>
