---
import Layout from '../layouts/Layout.astro';
import EventCard from '../components/ui/EventCard.astro';
import { getCollection } from 'astro:content';

const allEvents = await getCollection('events');
const allCategories = await getCollection('event-category');

// Get categories that actually have events
const categoriesWithEvents = allCategories.filter((category) =>
  allEvents.some((event) => event.data.category.toLowerCase() === category.data.id.toLowerCase())
);

// Sort categories by name
const sortedCategories = categoriesWithEvents.sort((a, b) =>
  a.data.name.localeCompare(b.data.name)
);

const sortedEvents = allEvents.sort(
  (a, b) => b.data.startDate.getTime() - a.data.startDate.getTime()
);

// Categories are dynamically generated from content collection
---

<Layout
  title="Events"
  description="Discover upcoming events, festivals, and experiences in Gelephu Mindfulness City"
  mainClass="pt-0"
>
  <div class="min-h-screen">
    <!-- Hero Section -->
    <div
      class="events-hero relative h-[50vh] w-full overflow-hidden flex items-center justify-center"
    >
      <img
        src="/backgrounds/home-background.jpg"
        alt="Events"
        class="absolute h-full w-full object-cover"
      />
      <div class="absolute inset-0 z-10 bg-linear-to-b from-black/50 via-black/30 to-black/60">
      </div>
      <!-- Title -->
      <div class="relative z-10 text-center px-4">
        <h1 class="events-hero-title text-4xl font-bold text-white md:text-5xl lg:text-6xl">
          Events
        </h1>
        <p class="events-hero-subtitle mt-4 text-lg text-white md:text-xl">
          Discover upcoming events, festivals, and experiences
        </p>
      </div>
    </div>

    <!-- Navigation Section -->
    <div class="events-tabs-section border-b">
      <div class="mx-auto max-w-7xl">
        <div class="container mx-auto px-4 py-6 text-center md:px-8 md:py-8">
          <div class="flex flex-wrap justify-center gap-4 md:gap-8" id="events-tabs">
            <button
              data-tab="all"
              data-category-name="All Events"
              class="events-tab active cursor-pointer border-b-2 px-2 pb-3 transition-colors md:px-1 md:pb-4 md:text-lg"
            >
              All Events
            </button>
            {
              sortedCategories.map((category) => (
                <button
                  data-tab={category.data.id.toLowerCase()}
                  data-category-name={category.data.name}
                  class="events-tab cursor-pointer border-b-2 px-2 pb-3 transition-colors md:px-1 md:pb-4 md:text-lg"
                >
                  {category.data.name}
                </button>
              ))
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Content Section -->
    <div class="events-content-section container mx-auto px-4 py-16 md:px-8">
      <h2 class="events-section-title mb-8 text-center text-3xl font-bold" id="section-title">
        All Events
      </h2>

      <!-- Events Grid -->
      <div class="grid grid-cols-1 gap-6 md:grid-cols-3" id="events-grid">
        {
          sortedEvents.map((event, index) => (
            <article
              class={`events-card-wrapper ${index >= 6 ? 'hidden' : ''}`}
              data-category={event.data.category.toLowerCase()}
              data-event-id={event.id}
            >
              <EventCard event={event} variant="simple" />
            </article>
          ))
        }
      </div>

      <!-- Empty State -->
      <div class="hidden py-16 text-center" id="empty-state">
        <p class="events-empty-text">No events available at this time.</p>
      </div>

      <!-- Load More Indicator -->
      <div class="mt-8 hidden justify-center py-4" id="load-more">
        <div class="h-6 w-6 animate-spin rounded-full border-b-2 border-blue-600"></div>
      </div>
    </div>
  </div>
</Layout>

<script is:inline>
  let activeTab = 'all';
  let visibleCount = 6;
  const itemsPerLoad = 6;

  const tabs = document.querySelectorAll('.events-tab');
  const eventsCards = Array.from(document.querySelectorAll('.events-card-wrapper'));
  const sectionTitle = document.getElementById('section-title');
  const emptyState = document.getElementById('empty-state');
  const eventsGrid = document.getElementById('events-grid');
  const loadMoreIndicator = document.getElementById('load-more');

  // Get all events data from the page
  const allEventsData = eventsCards.map((card) => ({
    element: card,
    category: card.getAttribute('data-category') || '',
  }));

  function updateTitle(tab) {
    if (!sectionTitle) return;

    if (tab === 'all') {
      sectionTitle.textContent = 'All Events';
      return;
    }

    // Get category name from the tab button's data attribute
    const tabButton = Array.from(tabs).find((t) => t.getAttribute('data-tab') === tab);
    const categoryName = tabButton ? tabButton.getAttribute('data-category-name') : tab;
    sectionTitle.textContent = categoryName || tab;
  }

  function filterEvents(tab) {
    // Reset visible count when tab changes
    visibleCount = itemsPerLoad;

    // Filter events based on category
    const filteredEvents = allEventsData.filter((item) => {
      if (tab === 'all') return true;
      return item.category === tab;
    });

    // Hide all events first
    eventsCards.forEach((card) => {
      card.classList.add('hidden');
    });

    // Show only filtered and visible events
    const visibleEvents = filteredEvents.slice(0, visibleCount);
    visibleEvents.forEach((item) => {
      item.element.classList.remove('hidden');
    });

    // Show/hide empty state
    if (emptyState && eventsGrid) {
      if (filteredEvents.length === 0) {
        eventsGrid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        if (loadMoreIndicator) loadMoreIndicator.classList.add('hidden');
      } else {
        eventsGrid.classList.remove('hidden');
        emptyState.classList.add('hidden');

        // Show/hide load more indicator
        if (visibleCount < filteredEvents.length) {
          if (loadMoreIndicator) loadMoreIndicator.classList.remove('hidden');
        } else {
          if (loadMoreIndicator) loadMoreIndicator.classList.add('hidden');
        }
      }
    }
  }

  function loadMore() {
    const filteredEvents = allEventsData.filter((item) => {
      if (activeTab === 'all') return true;
      return item.category === activeTab;
    });

    visibleCount += itemsPerLoad;
    const visibleEvents = filteredEvents.slice(0, visibleCount);

    // Show the newly visible events
    visibleEvents.forEach((item) => {
      item.element.classList.remove('hidden');
    });

    // Hide load more indicator if all events are visible
    if (visibleEvents.length >= filteredEvents.length) {
      if (loadMoreIndicator) loadMoreIndicator.classList.add('hidden');
    }
  }

  // Tab click handlers
  tabs.forEach((tab) => {
    tab.addEventListener('click', () => {
      // Remove active class from all tabs
      tabs.forEach((t) => {
        t.classList.remove('active');
      });

      // Add active class to clicked tab
      tab.classList.add('active');

      // Get the tab type and filter
      const tabType = tab.getAttribute('data-tab') || 'all';
      activeTab = tabType;
      updateTitle(tabType);
      filterEvents(tabType);
    });
  });

  // Intersection Observer for infinite scroll
  if (loadMoreIndicator) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            loadMore();
          }
        });
      },
      { threshold: 0.1, rootMargin: '100px' }
    );

    observer.observe(loadMoreIndicator);
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    updateTitle(activeTab);
    filterEvents(activeTab);
  });
</script>

<style>
  .events-hero-title {
    color: #ffffff !important;
    line-height: 1.2;
  }

  .events-hero-subtitle {
    color: #ffffff !important;
  }

  :global([data-theme='light']) .events-hero-title,
  :global([data-theme='light']) .events-hero-subtitle {
    color: #ffffff !important;
  }

  .events-tabs-section {
    --events-bg: #000000;
    --events-text: #ffffff;
    --events-text-inactive: #9ca3af;
    --events-border: #ffffff;
    --events-border-inactive: transparent;
    background: var(--events-bg);
    border-color: rgba(255, 255, 255, 0.1);
  }

  :global([data-theme='light']) .events-tabs-section {
    --events-bg: #ffffff;
    --events-text: #000000;
    --events-text-inactive: #6b7280;
    --events-border: #000000;
    --events-border-inactive: transparent;
    border-color: rgba(0, 0, 0, 0.1);
  }

  .events-tab {
    color: var(--events-text-inactive);
    border-color: var(--events-border-inactive);
  }

  .events-tab.active {
    color: var(--events-text);
    border-color: var(--events-border);
  }

  .events-tab:hover:not(.active) {
    color: var(--events-text);
    opacity: 0.7;
  }

  .events-content-section {
    --events-content-bg: #000000;
    --events-heading: #ffffff;
    --events-body: #9ca3af;
    --events-card-bg: transparent;
    --events-card-border: transparent;
    background: var(--events-content-bg);
  }

  :global([data-theme='light']) .events-content-section {
    --events-content-bg: #ffffff;
    --events-heading: #111827;
    --events-body: #6b7280;
    --events-card-bg: transparent;
    --events-card-border: transparent;
  }

  .events-section-title {
    color: var(--events-heading);
  }

  .events-empty-text {
    color: var(--events-body);
  }
</style>
